# Принцип работы
Пользователь регистрируется в системе, у него создает баланс.
Когда выбран магазин-партнер из каталога, он осуществляет переход по ссылке, которую мы получили из рекламной сети admitad для данного магазина. Эта ссылка сохраняется в таблице shops, поле url. В action shops#redirect реализуется данный переход, где в качестве subID передается current_user.id.

Для учета покупок из Admitad используется статистика по действиям:
https://developers.admitad.com/doc/api/methods/statistics/statistics-actions/
При pending или approved_but_stalled, у пользователя (которого мы находим по subID - user.id) пополняется balance.amount.
Когда мы получаем ответ, что произошла выплата (paid: 1), мы пополняем balance.available_for_withdrawal на сумму комиссии, полагающуюся пользователю.
Запись данных из API происходит через очередь сообщений (sidekiq) в таблицу actions. Для обращения по расписанию, используем gem clockwork (удобная замена cron). Для избежания дублирования записей в actions, используем external_id - на стороне admitad это action_id (либо order_id), а все операции с балансом пользователя записываются в таблицу transactions. Сама запись (в том числе, обновление баланса) оборачивается в транзакцию для обеспечения целостности данных.

# Зависимости
* devise - регистрация, аутентификация пользователей
* httparty - wrapper для http-запросов к API
* sidekiq - очередь
* clockwork - scheduler
